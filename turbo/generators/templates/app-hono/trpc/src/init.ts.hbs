import { createLogger } from '@temp-repo/logger'
import type { Context } from '@temp-repo/{{ name }}-domain'
import { initTRPC, TRPCError } from '@trpc/server'
import type { FetchCreateContextFnOptions } from '@trpc/server/adapters/fetch'
import superjson from 'superjson'

const logger = createLogger('trpc')

const t = initTRPC.context<Context>().create({
  transformer: superjson,
  errorFormatter: ({ shape, error }) => {
    // Log all tRPC errors with context
    logger.error(
      {
        code: shape.code,
        path: shape.data?.path,
        httpStatus: shape.data?.httpStatus,
        err: error.message,
        cause: error.cause instanceof Error ? error.cause.message : undefined,
      },
      `tRPC error: ${error.message}`,
    )
    return shape
  },
})

export const router = t.router
export const mergeRouters = t.mergeRouters

//* Context
export const createContext = async ({ req }: FetchCreateContextFnOptions): Promise<Context> => {
  // Add your auth logic here to extract user from request
  // Example with cookies/tokens:
  // const token = req.headers.get('authorization')?.split(' ')[1]
  // const user = await verifyToken(token)

  return {
    user: null,
    session: null,
  }
}

//* Procedures
export const publicProcedure = t.procedure
export const protectedProcedure = t.procedure.use(async ({ next, ctx }) => {
  const { user, session } = ctx
  if (!session || !user) {
    throw new TRPCError({ code: 'UNAUTHORIZED' })
  }
  return next({ ctx: { user, session } })
})

